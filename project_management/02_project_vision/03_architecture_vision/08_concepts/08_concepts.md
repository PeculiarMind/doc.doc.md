# Crosscutting Concepts

## Filtering Logic

### Filter Criteria Types

The system supports three types of filter criteria:

1. **File Extensions**: Match files by extension (e.g., `.pdf`, `.txt`, `.md`)
2. **Glob Patterns**: Match files by path pattern (e.g., `**/2024/**`, `**/temp/**`)
3. **MIME Types**: Match files by MIME type (e.g., `application/pdf`, `text/plain`)

### Boolean Logic for Filters

#### Include Filter Logic

- **Within a single `--include` parameter** (comma-separated values):
  - Values are **ORed** together
  - A file matches if it satisfies **at least one** criterion
  - Example: `--include ".pdf,.txt"` → matches `.pdf` OR `.txt`

- **Between multiple `--include` parameters**:
  - Parameters are **ANDed** together
  - A file must match **at least one criterion from each** parameter
  - Example:
    ```bash
    --include ".pdf,.txt" --include "**/2024/**"
    # File must be (.pdf OR .txt) AND (in 2024 directory)
    ```

#### Exclude Filter Logic

- **Within a single `--exclude` parameter** (comma-separated values):
  - Values are **ORed** together
  - A file is excluded if it matches **at least one** criterion
  - Example: `--exclude ".log,.tmp"` → excludes `.log` OR `.tmp`

- **Between multiple `--exclude` parameters**:
  - Parameters are **ANDed** together
  - A file is excluded only if it matches **at least one criterion from each** parameter
  - Example:
    ```bash
    --exclude ".log" --exclude "**/temp/**"
    # File excluded only if (.log) AND (in temp directory)
    ```

### Filter Evaluation Algorithm

```python
def should_process_file(file_path, include_params, exclude_params):
    """
    Determine if a file should be processed based on include/exclude filters.
    
    Args:
        file_path: Path to the file
        include_params: List of include parameter strings (comma-separated criteria)
        exclude_params: List of exclude parameter strings (comma-separated criteria)
    
    Returns:
        bool: True if file should be processed
    """
    # If no include filters, include all files by default
    if not include_params:
        include_match = True
    else:
        # All include parameters must match (AND between parameters)
        include_match = all(
            # At least one criterion per parameter must match (OR within parameter)
            any(matches_criterion(file_path, criterion) 
                for criterion in param.split(','))
            for param in include_params
        )
    
    # If no exclude filters, exclude nothing by default
    if not exclude_params:
        exclude_match = False
    else:
        # All exclude parameters must match to exclude (AND between parameters)
        exclude_match = all(
            # At least one criterion per parameter must match (OR within parameter)
            any(matches_criterion(file_path, criterion)
                for criterion in param.split(','))
            for param in exclude_params
        )
    
    # Include if matches include criteria and does not match exclude criteria
    return include_match and not exclude_match

def matches_criterion(file_path, criterion):
    """Check if file matches a single criterion."""
    criterion = criterion.strip()
    
    # Extension match
    if criterion.startswith('.'):
        return file_path.endswith(criterion)
    
    # MIME type match
    elif '/' in criterion:
        mime_type = get_mime_type(file_path)
        return mime_type == criterion
    
    # Glob pattern match
    else:
        return fnmatch.fnmatch(file_path, criterion)
```

### Filter Examples

| Include Params | Exclude Params | File | Result | Reason |
|----------------|----------------|------|--------|--------|
| `.pdf,.txt` | None | `doc.pdf` | ✅ Include | Matches `.pdf` |
| `.pdf,.txt` | None | `data.csv` | ❌ Exclude | Doesn't match `.pdf` or `.txt` |
| `.pdf`, `**/2024/**` | None | `2024/doc.pdf` | ✅ Include | `.pdf` AND `**/2024/**` |
| `.pdf`, `**/2024/**` | None | `2023/doc.pdf` | ❌ Exclude | `.pdf` but NOT `**/2024/**` |
| `.pdf,.txt` | `.txt` | `doc.txt` | ❌ Exclude | Matches include but also exclude |
| `.pdf,.txt` | `.log`, `**/temp/**` | `temp/file.csv` | ✅ Include | Not excluded (doesn't match both exclude params) |
| `.pdf,.txt` | `.log`, `**/temp/**` | `temp/debug.log` | ❌ Exclude | Matches both `.log` AND `**/temp/**` |

## Template Processing

### Template Structure

Templates are markdown files with placeholder variables that are replaced with file-specific data.

```markdown
# {{file_name}}

**Path**: {{file_path}}
**Size**: {{file_size_human}}
**Type**: {{mime_type}}
**Modified**: {{modified_date}}

## Metadata

- **Permissions**: {{permissions}}
- **Owner**: {{owner}}
- **Created**: {{created_date}}

## Content Summary

{{content_summary}}

---
*Generated by doc.doc.md on {{generation_timestamp}}*
```

### Variable Substitution

| Variable | Source | Example Value |
|----------|--------|---------------|
| `{{file_name}}` | File system | `report.pdf` |
| `{{file_path}}` | File system | `/input/docs/2024/report.pdf` |
| `{{file_size}}` | stat plugin | `1048576` |
| `{{file_size_human}}` | stat plugin | `1.0 MB` |
| `{{mime_type}}` | file plugin | `application/pdf` |
| `{{mime_description}}` | file plugin | `PDF document, version 1.7` |
| `{{modified_date}}` | stat plugin | `2024-02-25 14:30:00` |
| `{{created_date}}` | stat plugin | `2024-02-20 09:15:00` |
| `{{permissions}}` | stat plugin | `rw-r--r--` |
| `{{owner}}` | stat plugin | `user:group` |
| `{{content_summary}}` | Content plugins | Plugin-specific |
| `{{generation_timestamp}}` | System | `2024-02-25 15:00:00` |

### Template Resolution Order

1. User-specified template via `--template` parameter
2. Custom template in `~/.config/doc.doc.md/templates/default.md`
3. Built-in template in `/usr/local/share/doc.doc.md/templates/default.md`

## Plugin Architecture

### Plugin Structure

Each plugin is a directory containing:

```
plugin_name/
├── descriptor.json       # Plugin metadata and configuration
├── main.sh              # Main plugin entry point
├── install.sh           # Installation script (optional)
└── installed.sh         # Installation check script (optional)
```

### Descriptor Format

```json
{
  "name": "stat",
  "version": "1.0.0",
  "description": "Provides file metadata using stat command",
  "author": "doc.doc.md team",
  "entry_point": "main.sh",
  "dependencies": [],
  "system_requirements": ["stat"],
  "input_types": ["*"],
  "output_variables": [
    "file_size",
    "file_size_human",
    "modified_date",
    "created_date",
    "permissions",
    "owner"
  ],
  "install_command": "install.sh",
  "check_installed": "installed.sh"
}
```

### Plugin Interface

**Input** (via environment variables):
- `FILE_PATH`: Absolute path to the file being processed
- `OUTPUT_DIR`: Directory for output generation
- `PLUGIN_DATA_DIR`: Directory for plugin-specific temporary data

**Output** (via stdout, JSON format):
```json
{
  "file_size": 1048576,
  "file_size_human": "1.0 MB",
  "modified_date": "2024-02-25 14:30:00",
  "permissions": "rw-r--r--"
}
```

### Plugin Execution Flow

1. **Discovery**: System scans plugin directory, loads descriptors
2. **Validation**: Check dependencies and system requirements
3. **Selection**: Determine applicable plugins for each file type
4. **Execution**: Run plugins in dependency order
5. **Aggregation**: Merge outputs from all plugins
6. **Template Application**: Substitute variables with aggregated data

### Plugin Dependency Resolution

```
Plugin A (no dependencies)
Plugin B (depends on Plugin A)
Plugin C (depends on Plugin B)

Execution order: A → B → C
```

Algorithm:
1. Build dependency graph from descriptors
2. Perform topological sort
3. Execute in sorted order
4. Pass previous plugin outputs to dependent plugins

## Error Handling

### Error Categories

| Category | Examples | Response |
|----------|----------|----------|
| **User Input Errors** | Invalid directory, malformed filter | Show error, usage hint, exit code 1 |
| **Configuration Errors** | Missing template, invalid descriptor | Show error, suggest fix, exit code 2 |
| **Plugin Errors** | Plugin crash, missing dependency | Show error, skip plugin, continue if possible |
| **File Processing Errors** | Unreadable file, permission denied | Log warning, skip file, continue |
| **System Errors** | Out of disk space, permission denied | Show error, exit code 3 |

### Error Reporting Format

```
ERROR: [Category] Message
  Location: /path/to/file or plugin_name
  Hint: Suggested action
  
  For more details, run with --verbose
```

Example:
```
ERROR: Plugin 'myplugin' dependency not met
  Location: plugins/myplugin/descriptor.json
  Hint: Install required dependency 'external-tool' or deactivate this plugin
  
  For more details, run with --verbose
```

## Logging and Progress Indication

### Log Levels

- **ERROR**: Critical issues preventing operation
- **WARN**: Non-critical issues, operation continues
- **INFO**: General information about progress (default)
- **DEBUG**: Detailed diagnostic information

### Progress Output

```
Processing documents...
[████████████████████████████░░░░] 75% (30/40 files)

Processed: /input/docs/report1.pdf → /output/docs/report1.md
Processed: /input/docs/report2.pdf → /output/docs/report2.md
Skipped: /input/logs/debug.log (excluded by filter)

Complete! 30 files processed, 5 skipped, 5 errors
```

## Security Considerations

### Input Validation

- **File Paths**: Validate all paths, prevent directory traversal attacks
- **Filter Patterns**: Validate glob patterns, prevent injection
- **Plugin Names**: Sanitize plugin names, prevent command injection

### Plugin Sandboxing (Future)

- Limit plugin file system access
- Resource limits (CPU, memory, disk)
- Network access restrictions

### Credential Handling

- Never log sensitive data
- Avoid storing credentials
- Use environment variables for sensitive configuration
